<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∑ –ì–æ–ª–æ—Å–æ–≤–∏–º –í–≤–æ–¥–æ–º - –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ</title>
    <style>
        /* CSS —Å—Ç–∏–ª—ñ –ø–æ—á–∏–Ω–∞—é—Ç—å—Å—è —Ç—É—Ç */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #e9e9e9;
        }

        .calculator {
            background-color: #dcdcdc;
            border-radius: 15px; /* –ó–∞–æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è –¥–ª—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            width: 95%;
            max-width: 480px; /* –¢—Ä–æ—Ö–∏ —à–∏—Ä—à–∏–π –¥–ª—è –Ω–æ–≤–∏—Ö –∫–Ω–æ–ø–æ–∫ */
            border: 1px solid #bbb;
        }

        .display-container {
             background-color: #f0f0f0;
             color: #222;
             padding: 10px 15px;
             border-bottom: 1px solid #bbb;
             min-height: 100px;
             display: flex;
             flex-direction: column;
             justify-content: space-between;
             position: relative;
             border-top-left-radius: 15px; /* –ó–∞–æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è */
             border-top-right-radius: 15px;
        }

        .display-indicators {
            position: absolute;
            top: 5px;
            left: 15px;
            font-size: 0.8em;
            color: #555;
            display: flex;
            gap: 10px;
        }
        #memory-indicator, #angle-indicator, #voice-status {
             font-weight: bold;
             min-width: 15px;
             text-align: center;
        }
        #voice-status {
            color: #007bff;
        }


        .previous-operand {
            color: #555;
            font-size: 0.9em;
            min-height: 20px;
            text-align: right;
        }

        .current-operand {
            color: #111;
            font-size: 1.8em;
            font-weight: 500;
            min-height: 50px;
            text-align: right;
            word-wrap: break-word;
            word-break: break-all;
            overflow-y: auto;
            max-height: 70px;
        }


        .buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* 5 —Å—Ç–æ–≤–ø—Ü—ñ–≤ */
            gap: 2px;
            background-color: #ccc;
            padding: 5px;
        }

        button {
            background-color: #f8f8f8;
            border: none;
            padding: 15px 0;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.15s ease, transform 0.1s ease;
            color: #333;
            text-align: center;
            border-radius: 8px; /* –ó–ê–û–ö–†–£–ì–õ–ï–ù–Ü –ö–ù–û–ü–ö–ò */
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        }
        button:hover {
            background-color: #eee;
        }
        button:active {
            background-color: #ddd;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
            transform: scale(0.98);
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —Ç–∏–ø—ñ–≤ –∫–Ω–æ–ø–æ–∫ */
         button[data-action="number"] { background-color: #fff; font-weight: 500; }
         button[data-action="number"]:hover { background-color: #f5f5f5; }
         button[data-action="number"]:active { background-color: #eee; }

         button.operator, button[data-action="parenthesis"], button[data-action="power"] { background-color: #f0f0f0; color: #444; }
         button.operator:hover, button[data-action="parenthesis"]:hover, button[data-action="power"]:hover { background-color: #e8e8e8; }
         button.operator:active, button[data-action="parenthesis"]:active, button[data-action="power"]:active { background-color: #ddd; }

         button.function, button[data-action="trig"], button[data-action="log"], button[data-action="factorial"], button[data-action="constant"], button[data-action="memory"], button[data-action="clear"], button[data-action="negate"], button[data-action="delete"], button#voice-input-btn {
            background-color: #e8e8e8; color: #333;
         }
         button.function:hover, button[data-action="trig"]:hover, button[data-action="log"]:hover, button[data-action="factorial"]:hover, button[data-action="constant"]:hover, button[data-action="memory"]:hover, button[data-action="clear"]:hover, button[data-action="negate"]:hover, button[data-action="delete"]:hover, button#voice-input-btn:hover {
             background-color: #ddd;
         }
         button.function:active, button[data-action="trig"]:active, button[data-action="log"]:active, button[data-action="factorial"]:active, button[data-action="constant"]:active, button[data-action="memory"]:active, button[data-action="clear"]:active, button[data-action="negate"]:active, button[data-action="delete"]:active, button#voice-input-btn:active {
             background-color: #ccc;
         }

        button.equals {
            background-color: #add8e6; color: #191970; font-weight: bold;
            grid-column: span 2;
        }
        button.equals:hover { background-color: #9acced; }
        button.equals:active { background-color: #87ceeb; }

        button[data-value="RAD"].active-mode {
             background-color: #b0e0e6; box-shadow: inset 0 0 3px rgba(0,0,0,0.2);
        }

        #voice-input-btn {
            font-size: 1.3em;
            background-color: #d4edda;
        }
        #voice-input-btn.listening {
             background-color: #f8d7da;
             animation: pulse 1.5s infinite;
        }

         @keyframes pulse {
             0% { box-shadow: 0 0 0 0 rgba(248, 215, 218, 0.7); }
             70% { box-shadow: 0 0 0 10px rgba(248, 215, 218, 0); }
             100% { box-shadow: 0 0 0 0 rgba(248, 215, 218, 0); }
         }

        @media (max-width: 400px) {
            .current-operand { font-size: 1.6em; }
            button { font-size: 1em; padding: 12px 0;}
            .display-container { min-height: 80px; }
        }
        /* CSS —Å—Ç–∏–ª—ñ –∑–∞–∫—ñ–Ω—á—É—é—Ç—å—Å—è —Ç—É—Ç */
    </style>
</head>
<body>
    <div class="calculator">
        <div class="display-container">
             <div class="display-indicators">
                 <span id="memory-indicator"></span>
                 <span id="angle-indicator">RAD</span>
                 <span id="voice-status"></span>
             </div>
            <div id="previous-operand" class="previous-operand"></div>
            <div id="current-operand" class="current-operand">0</div>
        </div>
        <div class="buttons">
            <button data-action="memory" data-value="MC">MC</button>
            <button data-action="memory" data-value="MR">MR</button>
            <button data-action="memory" data-value="MS">MS</button>
            <button data-action="memory" data-value="M+">M+</button>
            <button data-action="memory" data-value="M-">M-</button>
            <button data-action="angle-mode" data-value="RAD" class="active-mode">RAD</button>
            <button data-action="trig" data-value="sin(">sin</button>
            <button data-action="trig" data-value="cos(">cos</button>
            <button data-action="trig" data-value="tan(">tan</button>
            <button data-action="delete" data-value="DEL">DEL</button>
            <button data-action="power" data-value="**">x ∏</button>
            <button data-action="log" data-value="log10(">log</button>
            <button data-action="log" data-value="log(">ln</button>
            <button data-action="parenthesis" data-value="(">(</button>
            <button data-action="parenthesis" data-value=")">)</button>
            <button data-action="function" data-value="sqrt(">‚àöx</button>
            <button data-action="number" data-value="7">7</button>
            <button data-action="number" data-value="8">8</button>
            <button data-action="number" data-value="9">9</button>
            <button data-action="operator" data-value="/" class="operator">&divide;</button>
            <button data-action="factorial" data-value="factorial(">n!</button>
            <button data-action="number" data-value="4">4</button>
            <button data-action="number" data-value="5">5</button>
            <button data-action="number" data-value="6">6</button>
            <button data-action="operator" data-value="*" class="operator">&times;</button>
            <button data-action="constant" data-value="PI">œÄ</button>
            <button data-action="number" data-value="1">1</button>
            <button data-action="number" data-value="2">2</button>
            <button data-action="number" data-value="3">3</button>
            <button data-action="operator" data-value="-" class="operator">-</button>
            <button data-action="constant" data-value="E">e</button>
            <button data-action="negate" data-value="+/-">+/-</button>
            <button data-action="number" data-value="0">0</button>
            <button data-action="decimal" data-value=".">.</button>
            <button data-action="operator" data-value="+" class="operator">+</button>
            <button data-action="clear" data-value="AC">AC</button>
            <button data-action="clear" data-value="CE">CE</button>
            <button id="voice-input-btn">üé§</button>
            <button data-action="equals" class="equals" data-value="=">=</button>
        </div>
    </div>

    <script>
        // –î–æ–¥–∞—î–º–æ –æ–±–≥–æ—Ä—Ç–∫—É DOMContentLoaded –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ
        document.addEventListener('DOMContentLoaded', () => {

            // --- –§—É–Ω–∫—Ü—ñ—è —Ñ–∞–∫—Ç–æ—Ä—ñ–∞–ª—É ---
            window.factorial = function(n) {
                // ... (–∫–æ–¥ –±–µ–∑ –∑–º—ñ–Ω) ...
                if (n < 0) return NaN;
                if (n > 170) return Infinity;
                if (n === 0 || n === 1) return 1;
                let result = 1;
                for (let i = 2; i <= n; i++) { result *= i; }
                return result;
            }

            // --- –ö–ª–∞—Å –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ ---
            class ScientificCalculator {
                constructor(previousOperandTextElement, currentOperandTextElement, memoryIndicator, angleIndicator, voiceStatusIndicator) {
                    this.previousOperandTextElement = previousOperandTextElement;
                    this.currentOperandTextElement = currentOperandTextElement;
                    this.memoryIndicator = memoryIndicator;
                    this.angleIndicator = angleIndicator;
                    this.voiceStatusIndicator = voiceStatusIndicator;
                    this.isRadians = true;
                    this.memoryValue = 0;
                    this.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = this.SpeechRecognition ? new this.SpeechRecognition() : null;
                    this.isListening = false;

                    this.clearAll(); // –û—á–∏—â–µ–Ω–Ω—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
                    // this.updateDisplay(); // updateDisplay –≤–∏–∫–ª–∏—á–µ—Ç—å—Å—è –∑ clearAll
                    this.setupVoiceRecognition();
                }

                // --- –°—Ç–∞–Ω —Ç–∞ –û—á–∏—â–µ–Ω–Ω—è ---
                clearAll() {
                    this.currentExpression = '0';
                    this.previousResult = '';
                    this.isResultDisplayed = true;
                    this.openParentheses = 0;
                    console.log('clearAll called'); // –õ–æ–≥ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
                    this.updateDisplay();
                }
                clearEntry() { this.clearAll(); } // –°–ø—Ä–æ—â–µ–Ω–æ

                // --- –í–≤—ñ–¥ –î–∞–Ω–∏—Ö ---
                appendNumber(number) {
                     console.log(`appendNumber: ${number}`); // –õ–æ–≥
                     if (this.isResultDisplayed) {
                         this.currentExpression = number;
                         this.isResultDisplayed = false;
                     } else {
                         if (number === '0' && this.currentExpression.match(/(^|[\s(*+\-/**])0$/)) return; // –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–µ–≥—É–ª—è—Ä–∫—É —Å—Ç–µ–ø–µ–Ω—è
                         if (this.currentExpression.match(/[)eœÄ]$/i)) { this.currentExpression += '*'; }
                         // –Ø–∫—â–æ –ø–æ—Ç–æ—á–Ω–∏–π –≤–∏—Ä–∞–∑ '0', –∑–∞–º—ñ–Ω—é—î–º–æ –π–æ–≥–æ
                         if(this.currentExpression === '0') this.currentExpression = number;
                         else this.currentExpression += number;
                     }
                }
                appendDecimal() {
                     console.log(`appendDecimal`); // –õ–æ–≥
                    if (this.isResultDisplayed) { this.currentExpression = '0.'; this.isResultDisplayed = false; return; }
                     const match = this.currentExpression.match(/[\d.]+$/);
                     if (match && match[0].includes('.')) return;
                     if (!this.currentExpression.match(/[\d]$/)) {
                         if (this.currentExpression.match(/[eœÄ)]$/i)) { this.currentExpression += '*0.'; }
                         else { this.currentExpression += '0.'; }
                     } else { this.currentExpression += '.'; }
                }
                appendOperator(operator) {
                    console.log(`appendOperator: ${operator}`); // –õ–æ–≥
                    if (this.currentExpression.toString().startsWith('Error:') || this.currentExpression.toString().startsWith('–ü–æ–º–∏–ª–∫–∞:')) return;
                     this.isResultDisplayed = false;
                     // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –Ω–µ –∑–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è –≤–∂–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º (–∑ –ø—Ä–æ–±—ñ–ª–∞–º–∏ –∞–±–æ –±–µ–∑) –∞–±–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—é—á–æ—é –¥—É–∂–∫–æ—é
                     if (this.currentExpression.match(/([+\-*/]\s?|[(])$/)) {
                         // –î–æ–∑–≤–æ–ª—è—î–º–æ —Ç—ñ–ª—å–∫–∏ —É–Ω–∞—Ä–Ω–∏–π –º—ñ–Ω—É—Å –ø—ñ—Å–ª—è –¥—É–∂–∫–∏ –∞–±–æ —ñ–Ω—à–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
                         if (operator === '-' && !this.currentExpression.endsWith('- ')) {
                             this.currentExpression += '-'; // –î–æ–¥–∞—î–º–æ —è–∫ —á–∞—Å—Ç–∏–Ω—É —á–∏—Å–ª–∞
                         }
                         // –Ü–Ω–∞–∫—à–µ –Ω—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–±–∏–º–æ –∞–±–æ –∑–∞–º—ñ–Ω—é—î–º–æ (—è–∫—â–æ —Ç—Ä–µ–±–∞)
                         // –ù–∞–ø—Ä–∏–∫–ª–∞–¥, –º–æ–∂–Ω–∞ –∑–∞–º—ñ–Ω–∏—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—ñ–π –æ–ø–µ—Ä–∞—Ç–æ—Ä
                         else if (this.currentExpression.match(/[+\-*/]\s?$/)) {
                              this.currentExpression = this.currentExpression.replace(/[+\-*/]\s?$/, operator + ' ');
                         }
                         return; // –ù–µ –¥–æ–¥–∞–≤–∞—Ç–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä, —è–∫—â–æ –Ω–µ –º–æ–∂–Ω–∞
                     }
                     // –î–æ–¥–∞—î–º–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä, —è–∫—â–æ –≤–∏—Ä–∞–∑ –Ω–µ –ø–æ—Ä–æ–∂–Ω—ñ–π —ñ –Ω–µ –ø—Ä–æ—Å—Ç–æ '-'
                     else if (this.currentExpression !== '' && this.currentExpression !== '0' && this.currentExpression !== '-') {
                          this.currentExpression += ' ' + operator + ' ';
                     }
                     // –î–æ–∑–≤–æ–ª—è—î–º–æ –ø–æ—á–∞—Ç–∏ –∑ —É–Ω–∞—Ä–Ω–æ–≥–æ –º—ñ–Ω—É—Å–∞
                     else if (operator === '-' && (this.currentExpression === '0' || this.currentExpression === '')) {
                          this.currentExpression = '-';
                     }
                }
                 appendPowerOperator() {
                    console.log(`appendPowerOperator`); // –õ–æ–≥
                     if (this.currentExpression.toString().startsWith('Error:') || this.currentExpression.toString().startsWith('–ü–æ–º–∏–ª–∫–∞:') || this.currentExpression.match(/[+\-*/(.\s]$/) || this.currentExpression === '' || this.currentExpression === '0' || this.currentExpression === '-') return;
                     this.isResultDisplayed = false;
                     this.currentExpression += '**';
                 }
                appendParenthesis(paren) {
                    console.log(`appendParenthesis: ${paren}`); // –õ–æ–≥
                    if (this.isResultDisplayed && paren === '(') { this.currentExpression = '('; this.isResultDisplayed = false; this.openParentheses++; return; }
                     if (this.isResultDisplayed) this.isResultDisplayed = false; // –ü–æ—á–∏–Ω–∞—î–º–æ –Ω–æ–≤–∏–π –≤–∏—Ä–∞–∑
                     else if (this.currentExpression === '0') this.currentExpression = ''; // –û—á–∏—â–∞—î–º–æ '0' –ø–µ—Ä–µ–¥ –¥–æ–¥–∞–≤–∞–Ω–Ω—è–º

                     if (paren === '(') {
                         if (this.currentExpression.match(/[\d.)eœÄ]$/i)) { this.currentExpression += '*('; }
                         else { this.currentExpression += '('; }
                         this.openParentheses++;
                     } else if (paren === ')') {
                         if (this.openParentheses > 0 && !this.currentExpression.match(/[+\-*/(.\s]$/)) {
                             this.currentExpression += ')';
                             this.openParentheses--;
                         }
                     }
                }
                appendFunction(func) {
                    console.log(`appendFunction: ${func}`); // –õ–æ–≥
                     if (this.isResultDisplayed) { this.currentExpression = func; this.isResultDisplayed = false; }
                     else if (this.currentExpression === '0') { this.currentExpression = func; } // –ó–∞–º—ñ–Ω–∏—Ç–∏ 0
                     else {
                         if (this.currentExpression.match(/[\d.)eœÄ]$/i)) { this.currentExpression += '*' + func; }
                         else { this.currentExpression += func; }
                     }
                     if (!func.startsWith('factorial')) { this.openParentheses++; }
                     this.isResultDisplayed = false; // –ó–∞–≤–∂–¥–∏ –∑–Ω—ñ–º–∞—î–º–æ —Ñ–ª–∞–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
                }
                appendConstant(constSymbol) {
                    console.log(`appendConstant: ${constSymbol}`); // –õ–æ–≥
                     const constValue = constSymbol === 'PI' ? 'œÄ' : 'e';
                     if (this.isResultDisplayed) { this.currentExpression = constValue; this.isResultDisplayed = false; }
                      else if (this.currentExpression === '0') { this.currentExpression = constValue; } // –ó–∞–º—ñ–Ω–∏—Ç–∏ 0
                     else {
                         if (this.currentExpression.match(/[\d.)eœÄ]$/i)) { this.currentExpression += '*' + constValue; }
                         else { this.currentExpression += constValue; }
                     }
                     this.isResultDisplayed = false; // –ó–∞–≤–∂–¥–∏ –∑–Ω—ñ–º–∞—î–º–æ —Ñ–ª–∞–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
                }

                // --- –í–∏–¥–∞–ª–µ–Ω–Ω—è ---
                deleteLast() {
                     console.log(`deleteLast`); // –õ–æ–≥
                     if (this.isResultDisplayed) return;
                     if (this.currentExpression === '0') return; // –ù—ñ—á–æ–≥–æ –≤–∏–¥–∞–ª—è—Ç–∏

                     let expr = this.currentExpression;
                     let deleted = false;

                     // –í–∏–¥–∞–ª–µ–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–π, –æ–ø–µ—Ä–∞—Ç–æ—Ä—ñ–≤ –∑ –ø—Ä–æ–±—ñ–ª–∞–º–∏, —Å—Ç–µ–ø–µ–Ω—è
                     const patternsToRemove = [
                         /(sin|cos|tan|log10|log|sqrt|factorial)\($/i, // –§—É–Ω–∫—Ü—ñ—ó
                         /\s[+\-*/]\s$/,                             // –û–ø–µ—Ä–∞—Ç–æ—Ä–∏ –∑ –ø—Ä–æ–±—ñ–ª–∞–º–∏
                         /\*\*$/                                        // –°—Ç–µ–ø—ñ–Ω—å
                     ];

                     for (const pattern of patternsToRemove) {
                         const match = expr.match(pattern);
                         if (match) {
                             expr = expr.slice(0, -match[0].length);
                             if (pattern.source.includes('(') && !pattern.source.includes('factorial')) {
                                 this.openParentheses--;
                             }
                             deleted = true;
                             break;
                         }
                     }

                     // –í–∏–¥–∞–ª–µ–Ω–Ω—è –¥—É–∂–æ–∫, –∫–æ–Ω—Å—Ç–∞–Ω—Ç, —Å–∏–º–≤–æ–ª—ñ–≤
                     if (!deleted) {
                         const lastChar = expr.slice(-1);
                         expr = expr.slice(0, -1);
                         if (lastChar === '(') this.openParentheses--;
                         else if (lastChar === ')') this.openParentheses++;
                     }

                     // –Ø–∫—â–æ —Ä—è–¥–æ–∫ —Å—Ç–∞–≤ –ø–æ—Ä–æ–∂–Ω—ñ–º –∞–±–æ —Ç—ñ–ª—å–∫–∏ "-", —Å—Ç–∞–≤–∏–º–æ '0'
                     this.currentExpression = (expr === '' || expr === '-') ? '0' : expr;

                     // –Ø–∫—â–æ –≤–∏–¥–∞–ª–∏–ª–∏ –≤—Å–µ –¥–æ '0', –≤–≤–∞–∂–∞—î–º–æ —Ü–µ –ø–æ—á–∞—Ç–∫–æ–≤–∏–º —Å—Ç–∞–Ω–æ–º
                     if (this.currentExpression === '0') {
                         this.isResultDisplayed = true; // –©–æ–± –Ω–∞—Å—Ç—É–ø–Ω–µ —á–∏—Å–ª–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–ª–æ 0
                     }

                     this.updateDisplay(); // –û–Ω–æ–≤–ª—é—î–º–æ –æ–¥—Ä–∞–∑—É
                }


                // --- –Ü–Ω—à—ñ –§—É–Ω–∫—Ü—ñ—ó ---
                negate() {
                    console.warn("Negate function still needs proper implementation.");
                    // –ë–∞–∑–æ–≤–∞ —Å–ø—Ä–æ–±–∞: —è–∫—â–æ –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –º—ñ–Ω—è—î–º–æ –π–æ–≥–æ –∑–Ω–∞–∫
                     if (this.isResultDisplayed && this.previousResult && !this.previousResult.startsWith('–ü–æ–º–∏–ª–∫–∞:')) {
                         this.currentExpression = (-parseFloat(this.previousResult)).toString();
                         this.previousResult = this.currentExpression; // –û–Ω–æ–≤–ª—é—î–º–æ —ñ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                     }
                     // –Ü–Ω–∞–∫—à–µ - –ª–æ–≥—ñ–∫–∞ –∑–º—ñ–Ω–∏ –∑–Ω–∞–∫—É –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ —á–∏—Å–ª–∞ (—Å–∫–ª–∞–¥–Ω–æ)
                }
                toggleAngleMode() { this.isRadians = !this.isRadians; this.updateDisplay(); }

                // --- –ü–∞–º'—è—Ç—å ---
                handleMemory(operation) {
                     console.log(`handleMemory: ${operation}`); // –õ–æ–≥
                    let currentValue = NaN;
                     if (this.isResultDisplayed && this.previousResult && !this.previousResult.startsWith('–ü–æ–º–∏–ª–∫–∞:')) {
                         currentValue = parseFloat(this.previousResult);
                     } else {
                         try { currentValue = this.evaluateExpression(this.currentExpression); }
                         catch { currentValue = NaN; }
                     }
                     // ... (—Ä–µ—à—Ç–∞ –ª–æ–≥—ñ–∫–∏ M+, M-, MC, MR, MS –±–µ–∑ –∑–º—ñ–Ω) ...
                     switch(operation) {
                         case 'MC': this.memoryValue = 0; break;
                         case 'MR':
                              if (this.isResultDisplayed || this.currentExpression === '0') {
                                  this.currentExpression = this.memoryValue.toString();
                                  this.isResultDisplayed = false;
                              } else {
                                  if (this.currentExpression.match(/[\d.)eœÄ]$/i)) { this.currentExpression += '*' + this.memoryValue.toString(); }
                                  else { this.currentExpression += this.memoryValue.toString(); }
                              } break;
                         case 'MS': if (!isNaN(currentValue)) { this.memoryValue = currentValue; } else { this.previousOperandTextElement.innerText = "–ù–µ–º–æ–∂–ª–∏–≤–æ –∑–±–µ—Ä–µ–≥—Ç–∏"; } break;
                         case 'M+': if (!isNaN(currentValue)) { this.memoryValue += currentValue; } else { this.previousOperandTextElement.innerText = "–ù–µ–º–æ–∂–ª–∏–≤–æ –¥–æ–¥–∞—Ç–∏"; } break;
                         case 'M-': if (!isNaN(currentValue)) { this.memoryValue -= currentValue; } else { this.previousOperandTextElement.innerText = "–ù–µ–º–æ–∂–ª–∏–≤–æ –≤—ñ–¥–Ω—è—Ç–∏"; } break;
                     }
                     this.updateDisplay();
                }

                 // --- –û–±—á–∏—Å–ª–µ–Ω–Ω—è ---
                 evaluateExpression(expression) {
                     console.log(`Evaluating: "${expression}"`); // –õ–æ–≥
                     let evalExpression = expression.trim();
                     // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–∞–∫—Ä–∏—Ç—Ç—è –¥—É–∂–æ–∫ (–º–æ–∂–µ –±—É—Ç–∏ –Ω–µ–±–µ–∑–ø–µ—á–Ω–∏–º, –∫—Ä–∞—â–µ –≤–∏–º–∞–≥–∞—Ç–∏ –≤—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞)
                     // if (this.openParentheses > 0) { evalExpression += ')'.repeat(this.openParentheses); }
                     // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –Ω–µ–∑–∞–∫—Ä–∏—Ç—ñ –¥—É–∂–∫–∏ –ø–µ—Ä–µ–¥ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è–º
                     if(this.openParentheses !== 0) {
                        throw new Error("–ù–µ–∑–∞–∫—Ä–∏—Ç—ñ –¥—É–∂–∫–∏");
                     }
                     // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä –≤ –∫—ñ–Ω—Ü—ñ –≤–∏—Ä–∞–∑—É
                      if (evalExpression.match(/[+\-*/.]\s?$/) && !evalExpression.endsWith(')')) {
                         throw new Error("–í–∏—Ä–∞–∑ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ");
                      }

                     this.openParentheses = 0; // –°–∫–∏–¥–∞—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫

                     evalExpression = evalExpression
                         .replace(/œÄ/g, 'Math.PI').replace(/e/g, 'Math.E')
                         .replace(/log10\(/g, 'Math.log10(').replace(/log\(/g, 'Math.log(')
                         .replace(/sqrt\(/g, 'Math.sqrt(').replace(/sin\(/g, 'Math.sin(')
                         .replace(/cos\(/g, 'Math.cos(').replace(/tan\(/g, 'Math.tan(')
                         .replace(/factorial\(/g, 'window.factorial(')
                         .replace(/\^/g, '**').replace(/\s/g, ''); // –í–∏–¥–∞–ª—è—î–º–æ –ø—Ä–æ–±—ñ–ª–∏

                     console.log(`Formatted for eval: "${evalExpression}"`); // –õ–æ–≥

                     // ** –ü–û–ü–ï–†–ï–î–ñ–ï–ù–ù–Ø –ü–†–û –ë–ï–ó–ü–ï–ö–£ new Function() –ó–ê–õ–ò–®–ê–Ñ–¢–¨–°–Ø **
                     const calculate = new Function('"use strict"; return ' + evalExpression); // –î–æ–¥–∞—î–º–æ 'use strict'
                     let result = calculate();

                     if (!isFinite(result)) {
                         if (isNaN(result)) throw new Error("–ù–µ–≤—ñ—Ä–Ω–∏–π –≤–∏—Ä–∞–∑");
                         else throw new Error("–î—ñ–ª–µ–Ω–Ω—è –Ω–∞ –Ω—É–ª—å / –ü–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è");
                     }
                     return parseFloat(result.toPrecision(15));
                 }
                compute() {
                    console.log(`compute called`); // –õ–æ–≥
                    if (this.currentExpression.toString().startsWith('Error:') || this.currentExpression.toString().startsWith('–ü–æ–º–∏–ª–∫–∞:')) return;
                    // –Ø–∫—â–æ –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –Ω—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–±–∏–º–æ (–ø–æ–≤—Ç–æ—Ä–Ω–µ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è =)
                    if (this.isResultDisplayed && this.previousResult !== '') return;

                    try {
                        const result = this.evaluateExpression(this.currentExpression);
                        this.previousResult = result.toString();
                        this.currentExpression = this.previousResult;
                        this.isResultDisplayed = true;
                        this.previousOperandTextElement.innerText = '';
                        console.log(`Result: ${result}`); // –õ–æ–≥
                    } catch (error) {
                        console.error(`Evaluation error: ${error.message}`); // –õ–æ–≥ –ø–æ–º–∏–ª–∫–∏
                        this.previousResult = `–ü–æ–º–∏–ª–∫–∞: ${error.message}`;
                        // –ù–µ —Å–∫–∏–¥–∞—î–º–æ currentExpression –Ω–∞ 0, —â–æ–± –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –±–∞—á–∏–≤ –ø–æ–º–∏–ª–∫—É
                        this.currentExpression = this.previousResult; // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–º–∏–ª–∫—É –≤ –≥–æ–ª–æ–≤–Ω–æ–º—É –ø–æ–ª—ñ
                        this.isResultDisplayed = true;
                        this.previousOperandTextElement.innerText = ''; // –û—á–∏—â–∞—î–º–æ –≤–µ—Ä—Ö–Ω—ñ–π —Ä—è–¥–æ–∫
                    }
                     this.openParentheses = 0; // –°–∫–∏–¥–∞—î–º–æ –¥—É–∂–∫–∏
                }

                // --- –û–Ω–æ–≤–ª–µ–Ω–Ω—è –î–∏—Å–ø–ª–µ—è ---
                updateDisplay() {
                     console.log('updateDisplay called'); // –õ–æ–≥
                     this.memoryIndicator.innerText = this.memoryValue !== 0 ? 'M' : '';
                     this.angleIndicator.innerText = this.isRadians ? 'RAD' : 'DEG';
                     document.querySelectorAll('button[data-action="angle-mode"]').forEach(btn => {
                          btn.classList.remove('active-mode');
                          if ((this.isRadians && btn.dataset.value === 'RAD') || (!this.isRadians && btn.dataset.value === 'DEG')) { btn.classList.add('active-mode'); }
                     });

                     // –ü–æ–∫–∞–∑ –ø–æ–º–∏–ª–∫–∏
                     if (this.currentExpression.toString().startsWith('–ü–æ–º–∏–ª–∫–∞:')) {
                         this.currentOperandTextElement.innerText = this.currentExpression;
                         this.previousOperandTextElement.innerText = '';
                     }
                     // –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
                     else if (this.isResultDisplayed) {
                          this.currentOperandTextElement.innerText = this.formatNumber(this.currentExpression);
                          this.previousOperandTextElement.innerText = '';
                     }
                     // –ü–æ–∫–∞–∑ –≤–∏—Ä–∞–∑—É, —â–æ –≤–≤–æ–¥–∏—Ç—å—Å—è
                      else {
                         this.currentOperandTextElement.innerText = this.currentExpression
                             .replace(/Math\.PI/g, 'œÄ').replace(/Math\.E/g, 'e')
                             .replace(/\*\*/g, '^').replace(/window\.factorial\(/g, 'fact(');
                          if (this.previousResult && !this.previousResult.startsWith('–ü–æ–º–∏–ª–∫–∞:')) {
                             this.previousOperandTextElement.innerText = `Ans = ${this.formatNumber(this.previousResult)}`;
                          } else {
                             this.previousOperandTextElement.innerText = '';
                          }
                     }
                     this.adjustFontSize();
                }
                formatNumber(numberString) {
                    // ... (–∫–æ–¥ –±–µ–∑ –∑–º—ñ–Ω) ...
                     if (typeof numberString !== 'string' || numberString.startsWith('–ü–æ–º–∏–ª–∫–∞:')) return numberString;
                    try {
                        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –µ–∫—Å–ø–æ–Ω–µ–Ω—Ç–∏
                         if (numberString.toLowerCase().includes('e')) {
                             return numberString; // –ù–µ —Ñ–æ—Ä–º–∞—Ç—É—î–º–æ –µ–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–π–Ω–∏–π –∑–∞–ø–∏—Å
                         }
                        const number = parseFloat(numberString.replace(',', '.')); // –ó–∞–º—ñ–Ω—é—î–º–æ –∫–æ–º—É –Ω–∞ –∫—Ä–∞–ø–∫—É –¥–ª—è parseFloat
                        if (isNaN(number)) return numberString;
                        return number.toLocaleString('uk-UA', { maximumFractionDigits: 10 }).replace('.', ',');
                    } catch { return numberString; }
                }
                 adjustFontSize() {
                    const element = this.currentOperandTextElement;
                    if (!element) return; // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è –µ–ª–µ–º–µ–Ω—Ç–∞
                    const container = element.parentElement;
                    if (!container) return;

                    let fontSize = parseFloat(window.getComputedStyle(element).fontSize);
                    const baseFontSizePx = 1.8 * parseFloat(window.getComputedStyle(document.body).fontSize || 16); // 1.8em –≤ –ø—ñ–∫—Å–µ–ª—è—Ö

                    element.style.fontSize = (baseFontSizePx / 16) + 'em'; // Reset to base size in em

                    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ requestAnimationFrame –¥–ª—è –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è –ø—ñ—Å–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É
                    requestAnimationFrame(() => {
                        const scrollWidth = element.scrollWidth;
                        const clientWidth = element.clientWidth;

                        if (scrollWidth > clientWidth) {
                            const ratio = clientWidth / scrollWidth;
                            let newFontSizePx = Math.max(1.0 * 16, baseFontSizePx * ratio * 0.95); // * 0.95 –∑–∞–ø–∞—Å
                            element.style.fontSize = (newFontSizePx / 16) + 'em';
                        } else {
                            element.style.fontSize = (baseFontSizePx / 16) + 'em'; // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –±–∞–∑–æ–≤–∏–π —Ä–æ–∑–º—ñ—Ä
                        }
                    });
                }

                // --- –ì–æ–ª–æ—Å–æ–≤–∏–π –í–≤—ñ–¥ —Ç–∞ –û–±—Ä–æ–±–∫–∞ ---
                setupVoiceRecognition() {
                    if (!this.recognition) {
                        console.error("Web Speech API –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è.");
                        this.voiceStatusIndicator.innerText = "–ì–æ–ª–æ—Å –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è";
                        return;
                    }
                    this.recognition.lang = 'uk-UA';
                    this.recognition.interimResults = false;
                    this.recognition.maxAlternatives = 1;

                    this.recognition.onstart = () => { /* ... (–±–µ–∑ –∑–º—ñ–Ω) ... */
                         this.isListening = true; this.voiceStatusIndicator.innerText = "–°–ª—É—Ö–∞—é...";
                         document.getElementById('voice-input-btn')?.classList.add('listening'); console.log("–†–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –ø–æ—á–∞–ª–æ—Å—è");
                    };
                    this.recognition.onresult = (event) => { /* ... (–±–µ–∑ –∑–º—ñ–Ω) ... */
                        const transcript = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
                        console.log('–†–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ:', transcript); this.voiceStatusIndicator.innerText = "–û–±—Ä–æ–±–∫–∞...";
                        this.processVoiceCommand(transcript);
                    };
                    this.recognition.onerror = (event) => { /* ... (–±–µ–∑ –∑–º—ñ–Ω) ... */
                         this.isListening = false; let errorMessage = "–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è";
                         if (event.error === 'no-speech') errorMessage = "–ù—ñ—á–æ–≥–æ –Ω–µ –ø–æ—á—É–≤";
                         else if (event.error === 'audio-capture') errorMessage = "–ü—Ä–æ–±–ª–µ–º–∞ –∑ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–æ–º";
                         else if (event.error === 'not-allowed') errorMessage = "–î–æ–∑–≤—ñ–ª –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ";
                         else errorMessage += `: ${event.error}`;
                         this.voiceStatusIndicator.innerText = errorMessage; console.error('–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è:', event.error);
                         document.getElementById('voice-input-btn')?.classList.remove('listening');
                    };
                    this.recognition.onend = () => { /* ... (–±–µ–∑ –∑–º—ñ–Ω) ... */
                         this.isListening = false; console.log("–†–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –∑–∞–∫—ñ–Ω—á–∏–ª–æ—Å—è");
                         document.getElementById('voice-input-btn')?.classList.remove('listening');
                         this.updateDisplay(); // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∏—Å–ø–ª–µ–π –ü–Ü–°–õ–Ø –æ–±—Ä–æ–±–∫–∏ –∫–æ–º–∞–Ω–¥–∏
                    };
                }
                toggleListening() { /* ... (–±–µ–∑ –∑–º—ñ–Ω) ... */
                     if (!this.recognition) return; if (this.isListening) { this.recognition.stop(); }
                     else { try { this.recognition.start(); } catch (e) { console.error("–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–æ—á–∞—Ç–∏ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è:", e); this.voiceStatusIndicator.innerText = "–ü–æ–º–∏–ª–∫–∞ —Å—Ç–∞—Ä—Ç—É"; this.isListening = false; document.getElementById('voice-input-btn')?.classList.remove('listening'); } }
                }
                processVoiceCommand(command) {
                    console.log(`–û–±—Ä–æ–±–∫–∞ –∫–æ–º–∞–Ω–¥–∏: "${command}"`);
                     let processed = command;
                     const replacements = { /* ... (—Å–ª–æ–≤–Ω–∏–∫ –±–µ–∑ –∑–º—ñ–Ω) ... */
                        '–Ω—É–ª—å': '0', '–æ–¥–∏–Ω': '1', '–¥–≤–∞': '2', '—Ç—Ä–∏': '3', '—á–æ—Ç–∏—Ä–∏': '4',
                        '–ø\'—è—Ç—å': '5', "–ø'—è—Ç—ñ—Ä–∫–∞": '5', '—à—ñ—Å—Ç—å': '6', '—Å—ñ–º': '7', '–≤—ñ—Å—ñ–º': '8', '–¥–µ–≤\'—è—Ç—å': '9',
                        '–¥–µ—Å—è—Ç—å': '10', '–æ–¥–∏–Ω–∞–¥—Ü—è—Ç—å': '11', '–¥–≤–∞–Ω–∞–¥—Ü—è—Ç—å': '12',
                        '–∫–æ–º–∞': '.', '–∫—Ä–∞–ø–∫–∞': '.',
                        '–ø–ª—é—Å': '+', '–¥–æ–¥–∞—Ç–∏': '+', '–º—ñ–Ω—É—Å': '-', '–≤—ñ–¥–Ω—è—Ç–∏': '-',
                        '–ø–æ–º–Ω–æ–∂–∏—Ç–∏': '*', '–Ω–∞': '*', '–ø–æ–¥—ñ–ª–∏—Ç–∏': '/', '—Ä–æ–∑–¥—ñ–ª–∏—Ç–∏': '/',
                        '—Å—Ç–µ–ø—ñ–Ω—å': '**', '–≤ —Å—Ç–µ–ø–µ–Ω—ñ': '**',
                        '–∫–æ—Ä—ñ–Ω—å –∫–≤–∞–¥—Ä–∞—Ç–Ω–∏–π –∑': 'sqrt(', '–∫–æ—Ä—ñ–Ω—å –∑': 'sqrt(', '–∫–æ—Ä—ñ–Ω—å': 'sqrt(',
                        '—Å–∏–Ω—É—Å': 'sin(', '–∫–æ—Å–∏–Ω—É—Å': 'cos(', '—Ç–∞–Ω–≥–µ–Ω—Å': 'tan(',
                        '–ª–æ–≥–∞—Ä–∏—Ñ–º –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–∏–π': 'log(', '–ª–æ–≥–∞—Ä–∏—Ñ–º –¥–µ—Å—è—Ç–∫–æ–≤–∏–π': 'log10(', '–ª–æ–≥–∞—Ä–∏—Ñ–º': 'log10(',
                        '—Ñ–∞–∫—Ç–æ—Ä—ñ–∞–ª': 'factorial(', '–ø—ñ': 'œÄ', '—á–∏—Å–ª–æ –ø—ñ': 'œÄ', '—á–∏—Å–ª–æ –µ': 'e',
                        '–¥–æ—Ä—ñ–≤–Ω—é—î': '=', '—Ä–µ–∑—É–ª—å—Ç–∞—Ç': '=', '–≤—ñ–¥–ø–æ–≤—ñ–¥—å': '=',
                        '–æ—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ': 'AC', '—Å—Ç–µ—Ä—Ç–∏ –≤—Å–µ': 'AC', '—Å–∫–∏–Ω—É—Ç–∏': 'AC',
                        '–æ—á–∏—Å—Ç–∏—Ç–∏': 'CE', '—Å—Ç–µ—Ä—Ç–∏': 'CE',
                        '–≤–∏–¥–∞–ª–∏—Ç–∏': 'DEL', '–Ω–∞–∑–∞–¥': 'DEL'
                     };
                     for (const [word, replacement] of Object.entries(replacements)) {
                         const regex = new RegExp(`\\b${word}\\b`, 'gi'); processed = processed.replace(regex, replacement);
                     }
                     processed = processed.replace(/\b(–∑|–≤—ñ–¥|—á–∏—Å–ª–æ|–¥–æ)\b/gi, '').replace(/\s+/g, ' ').trim();
                     console.log(`–ü—ñ—Å–ª—è –æ–±—Ä–æ–±–∫–∏: "${processed}"`);

                     if (processed === '=') { this.compute(); }
                     else if (processed === 'AC') { this.clearAll(); }
                     else if (processed === 'CE') { this.clearEntry(); }
                     else if (processed === 'DEL') { this.deleteLast(); }
                     else {
                         // –ó–∞–º—ñ—Å—Ç—å —ñ—Ç–µ—Ä–∞—Ü—ñ—ó —Å–∏–º–≤–æ–ª—ñ–≤, –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –≤–µ—Å—å —Ä–æ–∑–ø—ñ–∑–Ω–∞–Ω–∏–π —Ä—è–¥–æ–∫
                         // (—Ü–µ –º–æ–∂–µ –±—É—Ç–∏ –Ω–µ —ñ–¥–µ–∞–ª—å–Ω–æ, –∞–ª–µ –ø—Ä–æ—Å—Ç—ñ—à–µ)
                         if (this.isResultDisplayed || this.currentExpression === '0') {
                             this.currentExpression = processed;
                         } else {
                              // –ú–æ–∂–Ω–∞ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –¥–æ–¥–∞—Ç–∏ –¥–æ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –≤–∏—Ä–∞–∑—É, —è–∫—â–æ —Ü–µ –ª–æ–≥—ñ—á–Ω–æ
                              // –ù–∞–ø—Ä–∏–∫–ª–∞–¥, —è–∫—â–æ –ø–æ—Ç–æ—á–Ω–∏–π –≤–∏—Ä–∞–∑ –∑–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º
                              if (this.currentExpression.match(/[+\-*/]\s?$/)) {
                                  this.currentExpression += processed;
                              } else {
                                   // –ê–±–æ –ø—Ä–æ—Å—Ç–æ –∑–∞–º—ñ–Ω—é—î–º–æ - —Ü–µ –±–µ–∑–ø–µ—á–Ω—ñ—à–µ
                                  this.currentExpression = processed;
                              }
                         }
                         this.isResultDisplayed = false;
                         this.openParentheses = (processed.match(/\(/g) || []).length - (processed.match(/\)/g) || []).length;
                         // –ù–µ –≤–∏–∫–ª–∏–∫–∞—î–º–æ updateDisplay —Ç—É—Ç, –±–æ –≤—ñ–Ω –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –≤ onend
                     }
                }

            } // --- –ö—ñ–Ω–µ—Ü—å –∫–ª–∞—Å—É ScientificCalculator ---

            // --- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ç–∞ –ó–∞–ø—É—Å–∫ ---
            const previousOperandTextElement = document.getElementById('previous-operand');
            const currentOperandTextElement = document.getElementById('current-operand');
            const memoryIndicator = document.getElementById('memory-indicator');
            const angleIndicator = document.getElementById('angle-indicator');
            const voiceStatusIndicator = document.getElementById('voice-status');
            const buttons = document.querySelectorAll('.buttons button'); // –í–∏–±–∏—Ä–∞—î–º–æ –∫–Ω–æ–ø–∫–∏ —Ç—ñ–ª—å–∫–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ .buttons
            const voiceInputButton = document.getElementById('voice-input-btn');

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ –ø–µ—Ä–µ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
            if (!previousOperandTextElement || !currentOperandTextElement || !memoryIndicator || !angleIndicator || !voiceStatusIndicator) {
                console.error("–ü–æ–º–∏–ª–∫–∞: –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –æ–¥–∏–Ω –∞–±–æ –±—ñ–ª—å—à–µ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ –¥–∏—Å–ø–ª–µ—è/—ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞!");
                return;
            }

            const calculator = new ScientificCalculator(
                previousOperandTextElement,
                currentOperandTextElement,
                memoryIndicator,
                angleIndicator,
                voiceStatusIndicator
            );

            // –î–æ–¥–∞–≤–∞–Ω–Ω—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –ø–æ–¥—ñ–π –¥–ª—è –∫–Ω–æ–ø–æ–∫
            buttons.forEach(button => {
                if (button.id === 'voice-input-btn') return; // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –∫–Ω–æ–ø–∫—É –≥–æ–ª–æ—Å—É

                button.addEventListener('click', () => {
                    console.log(`Button clicked: action=${button.dataset.action}, value=${button.dataset.value}`); // –õ–æ–≥ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è
                    const action = button.dataset.action;
                    const value = button.dataset.value;

                    try { // –û–±–≥–æ—Ä—Ç–∞—î–º–æ –≤–∏–∫–ª–∏–∫ –º–µ—Ç–æ–¥—É –≤ try...catch
                        switch (action) {
                            case 'number': calculator.appendNumber(value); break;
                            case 'decimal': calculator.appendDecimal(); break;
                            case 'operator': calculator.appendOperator(value); break;
                            case 'power': calculator.appendPowerOperator(); break;
                            case 'parenthesis': calculator.appendParenthesis(value); break;
                            case 'trig': case 'log': case 'function': case 'factorial':
                                calculator.appendFunction(value); break;
                            case 'constant': calculator.appendConstant(value); break;
                            case 'equals': calculator.compute(); break;
                            case 'clear':
                                if (value === 'AC') calculator.clearAll();
                                else if (value === 'CE') calculator.clearEntry();
                                break;
                            case 'delete': calculator.deleteLast(); break;
                            case 'negate': calculator.negate(); break;
                            case 'angle-mode': calculator.toggleAngleMode(); break;
                            case 'memory': calculator.handleMemory(value); break;
                            default: console.warn(`–ù–µ–≤—ñ–¥–æ–º–∞ –¥—ñ—è: ${action}`);
                        }
                        // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∏—Å–ø–ª–µ–π –ø—ñ—Å–ª—è –∫–æ–∂–Ω–æ—ó –¥—ñ—ó, –∫—Ä—ñ–º delete (–≤—ñ–Ω –æ–Ω–æ–≤–ª—é—î —Å–∞–º)
                        if (action !== 'delete') {
                            calculator.updateDisplay();
                        }
                    } catch (error) {
                        console.error("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –æ–±—Ä–æ–±–∫–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏:", error);
                        // –ú–æ–∂–Ω–∞ –ø–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–º–∏–ª–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
                        calculator.currentExpression = "–í–Ω—É—Ç—Ä—ñ—à–Ω—è –ø–æ–º–∏–ª–∫–∞";
                        calculator.isResultDisplayed = true;
                        calculator.updateDisplay();
                    }
                });
            });

            // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥—É
            if (voiceInputButton) {
                voiceInputButton.addEventListener('click', () => {
                     console.log('Voice button clicked'); // –õ–æ–≥
                    calculator.toggleListening();
                });
            } else {
                console.error("–ö–Ω–æ–ø–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥—É (#voice-input-btn) –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞!");
            }

            // --- –û–±—Ä–æ–±–∫–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ ---
             document.addEventListener('keydown', (event) => {
                 const key = event.key;
                 let buttonToClick = null;
                 // ... (—Ä–µ—à—Ç–∞ –∫–æ–¥—É –æ–±—Ä–æ–±–∫–∏ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ –±–µ–∑ –∑–º—ñ–Ω) ...
                  if (key >= '0' && key <= '9') buttonToClick = document.querySelector(`button[data-action="number"][data-value="${key}"]`);
                  else if (key === '.' || key === ',') buttonToClick = document.querySelector('button[data-action="decimal"]');
                  else if (key === '+' || key === '-' || key === '*' || key === '/') buttonToClick = document.querySelector(`button[data-action="operator"][data-value="${key}"]`);
                  else if (key === '^') buttonToClick = document.querySelector('button[data-action="power"]');
                  else if (key === '(') buttonToClick = document.querySelector('button[data-action="parenthesis"][data-value="("]`);
                  else if (key === ')') buttonToClick = document.querySelector('button[data-action="parenthesis"][data-value=")"]');
                  else if (key === '!') buttonToClick = document.querySelector('button[data-action="factorial"]');
                  else if (key.toLowerCase() === 'p') buttonToClick = document.querySelector('button[data-action="constant"][data-value="PI"]');
                  else if (key.toLowerCase() === 'e') buttonToClick = document.querySelector('button[data-action="constant"][data-value="E"]');
                  else if (key === 'Enter' || key === '=') buttonToClick = document.querySelector('button[data-action="equals"]');
                  else if (key === 'Backspace') buttonToClick = document.querySelector('button[data-action="delete"]');
                  else if (key === 'Escape') buttonToClick = document.querySelector('button[data-action="clear"][data-value="AC"]');
                  else if (key === 'Delete') buttonToClick = document.querySelector('button[data-action="clear"][data-value="CE"]');

                 if (buttonToClick) {
                     event.preventDefault();
                     buttonToClick.click();
                     buttonToClick.classList.add('active-key');
                     setTimeout(() => buttonToClick.classList.remove('active-key'), 100);
                 }
             });
              const keyStyle = document.createElement('style');
              keyStyle.innerHTML = `button.active-key { background-color: #ccc !important; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2) !important; }`;
              document.head.appendChild(keyStyle);

        }); // –ö—ñ–Ω–µ—Ü—å –æ–±–≥–æ—Ä—Ç–∫–∏ DOMContentLoaded
    </script>
</body>
</html>
